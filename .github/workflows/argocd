name: React Application

on:
  push:
    branches: ['main']

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [14.20.0]

    steps:
    - uses: actions/checkout@v3
    - name: use Node.js ${{matrix.node-version}}
      uses: actions/setup-node@v3
      with:
        node-version: ${{ matrix.node-version}}
        cache: 'npm'
    - run : 'npm' 
    - npm run build --if apiVersion: v1
    kind: PersistentVolume
    metadata:
      name: 
      
  test-stage:
    runs-on: ubuntu-latest
    needs: build
    steps:
    - name: Running Tests
      uses: actions/checkout@v3
    - run: echo "running"

  build and push docker-image:
    name: Build Docker image and push to repositories

    runs-on: ubuntu-latest
    needs: ['build', 'test-stage']

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        
      - name: Set up Docker Buildx
        id: buildx
        uses: docker/setup-buildx-action@v2

      -  name: Login to DockerHub
         uses: docker/login-action@v2
         with:  
            username: ${{ secrets.DOCKERHUB_USERNAME }}
            password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Login to Github Packages
        uses: docker/login-actions@v2
        with: 
          registry: ghcr.io
          username: ${{ github.actor}}
          password: ${{secrets.G_TOKEN}}

      -  name: Build and push
         uses: docker/build-push-action@v4
         with:
            context: ./
          
            tags: /
                birinyem94/argocd:${{ github.sha }}
                ghcr.io/imrishav/gitops01:${{ github.sha}}

            push: ${{ github.ref == 'refs/head/master'}}

      - name: Image digest
        run: echo ${{ steps.docker_build.output.digest }}

update-manifest-stage:
    needs: ['build-and-push-docker-image']
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        name: changing the deployment of git repo
        with:
          repository: Birinyem94/argocd
          ref: 'master'
          token: ${{ secrets.GIT_TOKEN}}
      - name: set git config
        run: /
          git config user.email "omotolairinyemi4@gmail.com"
          git config user.name "Birinyemi94"
          echo ${{github.sha}}
          sed -i "s#${{ github.actor}}. *#${{ github.actor }}/argocd:${{ github.sha }}#g" deployment.yaml
          git add -A
          git commit -m "update image for" ${{ github.sha }}'
          git push origin main
